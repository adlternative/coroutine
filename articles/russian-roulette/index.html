



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
        <meta name="description" content="C++ 20 Coroutines in Action.">
      
      
        <link rel="canonical" href="https://luncliff.github.io/coroutine/articles/russian-roulette/">
      
      
        <meta name="author" content="Park DongHa">
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.6.3">
    
    
      
        <title>Russian Roulette and C++ Coroutines - luncliff/coroutine</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/application.adb8469c.css">
      
        <link rel="stylesheet" href="../../assets/stylesheets/application-palette.a8b3c06d.css">
      
      
        
        
        <meta name="theme-color" content="">
      
    
    
      <script src="../../assets/javascripts/modernizr.86422ebf.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../assets/fonts/material-icons.css">
    
    
    
      
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="white" data-md-color-accent="blue">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#russian-roulette-and-c-coroutines" tabindex="0" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="https://luncliff.github.io/coroutine" title="luncliff/coroutine" aria-label="luncliff/coroutine" class="md-header-nav__button md-logo">
          
            <i class="md-icon">call_split</i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              luncliff/coroutine
            </span>
            <span class="md-header-nav__topic">
              
                Russian Roulette and C++ Coroutines
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" aria-label="search" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="http://github.com/luncliff/coroutine/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    luncliff/coroutine
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main" role="main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="https://luncliff.github.io/coroutine" title="luncliff/coroutine" class="md-nav__button md-logo">
      
        <i class="md-icon">call_split</i>
      
    </a>
    luncliff/coroutine
  </label>
  
    <div class="md-nav__source">
      


  

<a href="http://github.com/luncliff/coroutine/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    luncliff/coroutine
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-1" type="checkbox" id="nav-1">
    
    <label class="md-nav__link" for="nav-1">
      PPT
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-1">
        PPT
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../ppt/Exploring-the-Cpp-Coroutine/" title="C++ Korea 5th Seminar" class="md-nav__link">
      C++ Korea 5th Seminar
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2" checked>
    
    <label class="md-nav__link" for="nav-2">
      Articles
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        Articles
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../exploring-msvc-coroutine/" title="Exploring MSVC Coroutine" class="md-nav__link">
      Exploring MSVC Coroutine
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../awaitable-event/" title="Awaitable event using the coroutine, epoll and eventfd" class="md-nav__link">
      Awaitable event using the coroutine, epoll and eventfd
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../designing-the-channel/" title="Designing the coroutine channel" class="md-nav__link">
      Designing the coroutine channel
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../combining-coroutines-and-pthread_create/" title="Combining C++ coroutines and `pthread_create`" class="md-nav__link">
      Combining C++ coroutines and `pthread_create`
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Russian Roulette and C++ Coroutines
      </label>
    
    <a href="./" title="Russian Roulette and C++ Coroutines" class="md-nav__link md-nav__link--active">
      Russian Roulette and C++ Coroutines
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#making-a-revolver-1-chambertrigger" class="md-nav__link">
    Making a revolver 1: Chamber/Trigger
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#defining-the-players-behavior" class="md-nav__link">
    Defining the players' behavior
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#making-a-revolver-2" class="md-nav__link">
    Making a revolver 2
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#progress-of-the-game" class="md-nav__link">
    Progress of the game
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#return-type-for-the-player-coroutine" class="md-nav__link">
    Return type for the player coroutine
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#exposing-the-player-coroutines-frame" class="md-nav__link">
    Exposing the player coroutine's frame
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#conclusion" class="md-nav__link">
    Conclusion
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      Code
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Code
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../modules/" title="Groups" class="md-nav__link">
      Groups
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../namespaces/" title="Namespaces" class="md-nav__link">
      Namespaces
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../functions/" title="Functions" class="md-nav__link">
      Functions
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../classes/" title="Classes" class="md-nav__link">
      Classes
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../files/" title="Files" class="md-nav__link">
      Files
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#making-a-revolver-1-chambertrigger" class="md-nav__link">
    Making a revolver 1: Chamber/Trigger
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#defining-the-players-behavior" class="md-nav__link">
    Defining the players' behavior
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#making-a-revolver-2" class="md-nav__link">
    Making a revolver 2
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#progress-of-the-game" class="md-nav__link">
    Progress of the game
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#return-type-for-the-player-coroutine" class="md-nav__link">
    Return type for the player coroutine
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#exposing-the-player-coroutines-frame" class="md-nav__link">
    Exposing the player coroutine's frame
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#conclusion" class="md-nav__link">
    Conclusion
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="http://github.com/luncliff/coroutine/edit/master/docs/articles/russian-roulette.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="russian-roulette-and-c-coroutines">Russian Roulette and C++ Coroutines<a class="headerlink" href="#russian-roulette-and-c-coroutines" title="Permanent link">&para;</a></h1>
<p><a href="../russian-roulette-kor/">한국어</a></p>
<p>In this post, I'd like to show an example which separates definition of a behavior and its execution.</p>
<p>For the example, the Russian Roulette is used.
Following its famous rule, the players' behavior are defined using the coroutine and a game with those players will written be written in an ordinary subroutine.</p>
<h3 id="making-a-revolver-1-chambertrigger">Making a revolver 1: Chamber/Trigger<a class="headerlink" href="#making-a-revolver-1-chambertrigger" title="Permanent link">&para;</a></h3>
<p>Let's start with makeing a revolver. Since we don't know how many players are going to join, <code>uint32_t</code> will be used to define the value space for the chamber.
And we need an additional function, <code>select_chamber</code>, to select one chamber value.</p>
<div class="codehilite"><pre><span></span><code><span class="cp">#include</span> <span class="cpf">&lt;random&gt;</span><span class="cp"></span>

<span class="c1">//  for this example,</span>
<span class="c1">//  chamber_t is the indices of the revolver&#39;s chambers</span>
<span class="k">using</span> <span class="n">chamber_t</span> <span class="o">=</span> <span class="kt">uint32_t</span><span class="p">;</span>

<span class="k">auto</span> <span class="nf">select_chamber</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">chamber_t</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">random_device</span> <span class="n">device</span><span class="p">{};</span>
    <span class="n">std</span><span class="o">::</span><span class="n">mt19937_64</span> <span class="n">gen</span><span class="p">{</span><span class="n">device</span><span class="p">()};</span>
    <span class="k">return</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">chamber_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">gen</span><span class="p">());</span>
<span class="p">}</span>
</code></pre></div>


<p>This is indeed the most simple implementation. It might be more complex for the real case, but let's use it anyway. </p>
<p>We need a trigger now. Of course it can be <code>pull</code>ed, and it knows which chamber is <code>loaded</code> and which chamber is going to be fired for the moment(<code>current</code>).
After pull operation, simply decreasing 1 from the <code>chamber_t</code>'s value. Remind that we are going to use a revolver!</p>
<div class="codehilite"><pre><span></span><code><span class="c1">//  trigger fires the bullet</span>
<span class="k">class</span> <span class="nc">trigger_t</span> <span class="p">{</span>
  <span class="k">protected</span><span class="o">:</span>
    <span class="k">const</span> <span class="n">chamber_t</span><span class="o">&amp;</span> <span class="n">loaded</span><span class="p">;</span>
    <span class="n">chamber_t</span> <span class="n">current</span><span class="p">;</span>

  <span class="k">public</span><span class="o">:</span>
    <span class="n">trigger_t</span><span class="p">(</span><span class="k">const</span> <span class="n">chamber_t</span><span class="o">&amp;</span> <span class="n">_loaded</span><span class="p">,</span> <span class="n">chamber_t</span> <span class="n">_current</span><span class="p">)</span>
        <span class="o">:</span> <span class="n">loaded</span><span class="p">{</span><span class="n">_loaded</span><span class="p">},</span> <span class="n">current</span><span class="p">{</span><span class="n">_current</span><span class="p">}</span> <span class="p">{</span>
    <span class="p">}</span>

  <span class="k">private</span><span class="o">:</span>
    <span class="kt">bool</span> <span class="n">pull</span><span class="p">()</span> <span class="p">{</span> <span class="c1">// pull the trigger. is it the bad case?</span>
        <span class="k">return</span> <span class="o">--</span><span class="n">current</span> <span class="o">==</span> <span class="n">loaded</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// ...</span>
<span class="p">};</span>
</code></pre></div>


<h3 id="defining-the-players-behavior">Defining the players' behavior<a class="headerlink" href="#defining-the-players-behavior" title="Permanent link">&para;</a></h3>
<p>In addition to that, let's make the trigger to an awaitable type.
So all players can <strong>wait</strong> for the bullet after pulling it.</p>
<div class="codehilite"><pre><span></span><code><span class="c1">//  trigger fires the bullet</span>
<span class="c1">//  all players will &#39;wait&#39; for it</span>
<span class="k">class</span> <span class="nc">trigger_t</span> <span class="p">{</span>
    <span class="c1">// ...</span>
  <span class="k">public</span><span class="o">:</span>
    <span class="kt">bool</span> <span class="n">await_ready</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kt">void</span> <span class="n">await_suspend</span><span class="p">(</span><span class="n">coroutine_handle</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">}</span>
    <span class="kt">bool</span> <span class="n">await_resume</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">pull</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">};</span>
</code></pre></div>


<p>By doing so, each player will be in one of the 3 state.</p>
<ul>
<li>Pulled the trigger, and not fired. (Alive!)</li>
<li>Pulled the trigger, and fired. (Hold X to pay respect)</li>
<li>Waiting for its turn, and another player received the bullet.</li>
</ul>
<p>In the 'code' form, it will be like the following.  </p>
<p><code>index</code> is for distinguishing each <code>player</code> instance. <code>fired</code> should be non-local since the other player will monitor its value.
Also <code>trigger</code> is passed by reference because all players share 1 revolver.</p>
<div class="codehilite"><pre><span></span><code><span class="c1">//  this player will ...</span>
<span class="c1">//  1. be bypassed</span>
<span class="c1">//     (fired = false; then return)</span>
<span class="c1">//  2. receive the bullet</span>
<span class="c1">//     (fired = true; then return)</span>
<span class="c1">//  3. be skipped because of the other player became a victim</span>
<span class="c1">//     (destroyed when it is suspended - no output)</span>
<span class="k">auto</span> <span class="nf">player</span><span class="p">(</span><span class="n">gsl</span><span class="o">::</span><span class="n">index</span> <span class="n">id</span><span class="p">,</span> <span class="kt">bool</span><span class="o">&amp;</span> <span class="n">fired</span><span class="p">,</span> <span class="n">trigger_t</span><span class="o">&amp;</span> <span class="n">trigger</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">user_behavior_t</span> <span class="p">{</span>
    <span class="c1">// bang !</span>
    <span class="n">fired</span> <span class="o">=</span> <span class="k">co_await</span> <span class="n">trigger</span><span class="p">;</span>
    <span class="n">fired</span> <span class="o">?</span> <span class="n">printf</span><span class="p">(</span><span class="s">&quot;player %zu dead  :( </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">)</span>
          <span class="o">:</span> <span class="n">printf</span><span class="p">(</span><span class="s">&quot;player %zu alive :) </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>


<p>What a short function!</p>
<p>Remind that <code>trigger_t</code> is an awaitable type. So each player will <strong>suspend</strong> immediately after pulling the trigger. After all players become suspended, then we will <strong>resume</strong> them one by one. 
When a player is resumed, it will check the return value of the <code>await_resume</code> and notify the resule(<code>fired</code>) by storing the result.
Of course the <code>player</code> behavior branches with it.</p>
<h3 id="making-a-revolver-2">Making a revolver 2<a class="headerlink" href="#making-a-revolver-2" title="Permanent link">&para;</a></h3>
<p>Let me explain about the <code>user_behavior_t</code> after finishing the definition of the revolver and the game.
1 revolver owns 1 trigger. The point will be expressed through the implementation inheritance. In addition to that, <code>revolver_t</code> must be aware of the <code>loaded</code> chamber. </p>
<div class="codehilite"><pre><span></span><code><span class="c1">// revolver knows which is the loaded chamber</span>
<span class="k">class</span> <span class="nc">revolver_t</span> <span class="o">:</span> <span class="k">public</span> <span class="n">trigger_t</span> <span class="p">{</span>
    <span class="k">const</span> <span class="n">chamber_t</span> <span class="n">loaded</span><span class="p">;</span>

  <span class="k">public</span><span class="o">:</span>
    <span class="n">revolver_t</span><span class="p">(</span><span class="n">chamber_t</span> <span class="n">current</span><span class="p">,</span> <span class="n">chamber_t</span> <span class="n">num_player</span><span class="p">)</span>
        <span class="o">:</span> <span class="n">trigger_t</span><span class="p">{</span><span class="n">loaded</span><span class="p">,</span> <span class="n">num_player</span><span class="p">},</span> <span class="c1">//</span>
          <span class="n">loaded</span><span class="p">{</span><span class="n">current</span> <span class="o">%</span> <span class="n">num_player</span><span class="p">}</span> <span class="p">{</span>
    <span class="p">}</span>
<span class="p">};</span>
</code></pre></div>


<p>Because someone must <strong>win</strong> the prize, we didn't forget to apply modular arithmetic.</p>
<h3 id="progress-of-the-game">Progress of the game<a class="headerlink" href="#progress-of-the-game" title="Permanent link">&para;</a></h3>
<p>Now it's time to define a execution of the game. I already told you it's an ordinay subroutine.
Assume that we have 6 players for 1 game.</p>
<div class="codehilite"><pre><span></span><code><span class="cp">#include</span> <span class="cpf">&lt;array&gt;</span><span class="cp"></span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="p">[])</span> <span class="p">{</span>
    <span class="c1">// select some chamber with the users</span>
    <span class="n">array</span><span class="o">&lt;</span><span class="n">user_behavior_t</span><span class="p">,</span> <span class="mi">6</span><span class="o">&gt;</span> <span class="n">users</span><span class="p">{};</span>
    <span class="n">revolver_t</span> <span class="n">revolver</span><span class="p">{</span><span class="n">select_chamber</span><span class="p">(),</span>
                        <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">chamber_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">users</span><span class="p">.</span><span class="n">max_size</span><span class="p">())};</span>

    <span class="n">russian_roulette</span><span class="p">(</span><span class="n">revolver</span><span class="p">,</span> <span class="n">users</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">EXIT_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>


<p>The game, <code>russian_roulette</code> is invoked with the resources.
You may not aware of the the GSL(C++ Core <strong>G</strong>uideline <strong>S</strong>upport <strong>L</strong>ibrary), but don't take it so hard.
<code>gsl::span</code> is a pair of the pointer and length to support range-<code>for</code> statement, <code>gsl::finally</code> invokes a given funcion object in its destuction phase. Here, by using it we can guarantee clean up of the coroutine frame.</p>
<div class="codehilite"><pre><span></span><code><span class="cp">#include</span> <span class="cpf">&lt;gsl/gsl&gt;</span><span class="cp"></span>

<span class="c1">// the game will go on until the revolver fires its bullet</span>
<span class="k">auto</span> <span class="nf">russian_roulette</span><span class="p">(</span><span class="n">revolver_t</span><span class="o">&amp;</span> <span class="n">revolver</span><span class="p">,</span> <span class="n">gsl</span><span class="o">::</span><span class="n">span</span><span class="o">&lt;</span><span class="n">user_behavior_t</span><span class="o">&gt;</span> <span class="n">users</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">bool</span> <span class="n">fired</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

    <span class="c1">// spawn player coroutines with their id</span>
    <span class="n">gsl</span><span class="o">::</span><span class="n">index</span> <span class="n">id</span><span class="p">{};</span>
    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span><span class="o">&amp;</span> <span class="nl">user</span> <span class="p">:</span> <span class="n">users</span><span class="p">)</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">player</span><span class="p">(</span><span class="o">++</span><span class="n">id</span><span class="p">,</span> <span class="n">fired</span><span class="p">,</span> <span class="n">revolver</span><span class="p">);</span>

    <span class="c1">// cleanup the game on return</span>
    <span class="k">auto</span> <span class="n">on_finish</span> <span class="o">=</span> <span class="n">gsl</span><span class="o">::</span><span class="n">finally</span><span class="p">([</span><span class="n">users</span><span class="p">]</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">coroutine_handle</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">&gt;&amp;</span> <span class="nl">frame</span> <span class="p">:</span> <span class="n">users</span><span class="p">)</span>
            <span class="n">frame</span><span class="p">.</span><span class="n">destroy</span><span class="p">();</span>
    <span class="p">});</span>

    <span class="c1">// until there is a victim ...</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">id</span> <span class="o">=</span> <span class="mi">0u</span><span class="p">;</span> <span class="n">fired</span> <span class="o">==</span> <span class="nb">false</span><span class="p">;</span> <span class="n">id</span> <span class="o">=</span> <span class="p">(</span><span class="n">id</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">users</span><span class="p">.</span><span class="n">size</span><span class="p">())</span> <span class="p">{</span>
        <span class="c1">// continue the users&#39; behavior in round-robin manner</span>
        <span class="n">coroutine_handle</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">&gt;&amp;</span> <span class="n">task</span> <span class="o">=</span> <span class="n">users</span><span class="p">[</span><span class="n">id</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">task</span><span class="p">.</span><span class="n">done</span><span class="p">()</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span>
            <span class="n">task</span><span class="p">.</span><span class="n">resume</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>


<p>Like I said all <code>player</code>s share <code>fired</code> variable and <code>revolver</code> instance.
Their behavior is defined using the coroutine.
<code>russian_roulette</code> subroutine becomes the moderator of the game with the control flow. It's task is to continue this turn-based game by resuming each player coroutine.
When they are resumed through <code>task.resume()</code> first time, they will pull the trigger and suspend again.</p>
<p>The game continues (by resume) until <code>fired</code> becomes <code>true</code>.</p>
<p>When there is a victim, the subroutine will return and 
<code>on_finish</code> object will destroy all players' coroutine frame. Simply using <code>frame.destroy()</code> will do the work.</p>
<h3 id="return-type-for-the-player-coroutine">Return type for the player coroutine<a class="headerlink" href="#return-type-for-the-player-coroutine" title="Permanent link">&para;</a></h3>
<p>In C++ 20 Coroutines, the return type of the coroutine must fulfill the Coroutine Promise Requirement. <code>user_behavior_t</code> is such kind of the type.</p>
<blockquote>
<p>You can see the <a href="https://lewissbaker.github.io/2018/09/05/understanding-the-promise-type">Lewiss Baker's post about it</a>
</p>
</blockquote>
<p>The first thing we have to do is to define <code>user_behavior_t::promise_type</code> which manages the coroutine frame.
We can use <code>coroutine_traits&lt;user_behavior_t, ...&gt;::promise_type</code> to do the work, but let's go through the easy way :)</p>
<div class="codehilite"><pre><span></span><code><span class="cp">#include</span> <span class="cpf">&lt;experimental/coroutine&gt;</span><span class="cp"></span>

<span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="p">;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="o">::</span><span class="n">experimental</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">promise_manual_control</span> <span class="p">{</span>
  <span class="k">public</span><span class="o">:</span>
    <span class="k">auto</span> <span class="n">initial_suspend</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">suspend_always</span><span class="p">{};</span> <span class="c1">// suspend after invoke</span>
    <span class="p">}</span>
    <span class="k">auto</span> <span class="n">final_suspend</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">suspend_always</span><span class="p">{};</span> <span class="c1">// suspend after return</span>
    <span class="p">}</span>
    <span class="kt">void</span> <span class="n">unhandled_exception</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// this example never &#39;throw&#39;. so nothing to do</span>
    <span class="p">}</span>
<span class="p">};</span>
</code></pre></div>


<p>Each function's role is like the following.</p>
<ul>
<li><code>initial_suspend</code>: Decide whether to suspend after the coroutine functions is invoked. At this moment the coroutine's frame is allocated.</li>
<li><code>final_suspend</code>: Decide whether to suspend after the coroutine function is returned(<code>co_return</code>).</li>
<li><code>unhandled_exception</code>: Invoked when an exception is thrown in the coroutine function's body</li>
</ul>
<p>Returning <code>suspend_always</code> type means that the coroutine is willing to suspend for the defined moment. If you don't want to suspend and continue the flow, you should return <code>suspend_never</code>.<br />
For this example, <code>player</code> coroutine's creation, progress(suspend/resume), destruction 
is fully managed by the subroutine <code>russian_roulette</code>. 
So we will return <code>suspend_always</code> type and forget about the other concerns.</p>
<h3 id="exposing-the-player-coroutines-frame">Exposing the player coroutine's frame<a class="headerlink" href="#exposing-the-player-coroutines-frame" title="Permanent link">&para;</a></h3>
<p><code>user_behavior_t::promise_type</code> inherits <code>promise_manual_control</code> and add 2 funtion to meet the requirement.</p>
<ul>
<li><code>return_void</code>: invoked just after <code>co_return</code></li>
<li><code>get_return_object</code>: the function's return becomes the return type of the coroutine function. Here, we will return <code>user_behavior_t</code> directly.</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="c1">//  behavior will be defined as a coroutine</span>
<span class="k">class</span> <span class="nc">user_behavior_t</span> <span class="o">:</span> <span class="k">public</span> <span class="n">coroutine_handle</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="k">public</span><span class="o">:</span>
    <span class="k">class</span> <span class="nc">promise_type</span> <span class="o">:</span> <span class="k">public</span> <span class="n">promise_manual_control</span> <span class="p">{</span>
      <span class="k">public</span><span class="o">:</span>
        <span class="kt">void</span> <span class="n">return_void</span><span class="p">()</span> <span class="p">{</span>
        <span class="p">}</span>
        <span class="k">auto</span> <span class="n">get_return_object</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">user_behavior_t</span> <span class="p">{</span>
            <span class="k">return</span> <span class="p">{</span><span class="k">this</span><span class="p">};</span>
        <span class="p">}</span>
    <span class="p">};</span>

  <span class="k">private</span><span class="o">:</span>
    <span class="n">user_behavior_t</span><span class="p">(</span><span class="n">promise_type</span><span class="o">*</span> <span class="n">p</span><span class="p">)</span> <span class="o">:</span> <span class="n">coroutine_handle</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">&gt;</span><span class="p">{}</span> <span class="p">{</span>
        <span class="n">coroutine_handle</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">&gt;&amp;</span> <span class="n">self</span> <span class="o">=</span> <span class="o">*</span><span class="k">this</span><span class="p">;</span>
        <span class="n">self</span> <span class="o">=</span> <span class="n">coroutine_handle</span><span class="o">&lt;</span><span class="n">promise_type</span><span class="o">&gt;::</span><span class="n">from_promise</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">);</span>
    <span class="p">}</span>

  <span class="k">public</span><span class="o">:</span>
    <span class="n">user_behavior_t</span><span class="p">()</span> <span class="o">=</span> <span class="k">default</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>


<p>The inheritance is <code>public</code>. 
So it exposes those member functions which controls the coroutine. (<code>resume</code>, <code>done</code>, and <code>destroy</code>)</p>
<p>After its base class construction, <code>coroutine_handle&lt;void&gt;</code> is in the empty state.
Here, I used the simplest way to <strong>translate</strong> <code>promise_type</code> to its matching <code>coroutine_handle&lt;void&gt;</code>. 
You can see that <code>from_promise</code> of the <code>coroutine_handle&lt;promise_type&gt;</code> is doing the work.</p>
<p>Unless we trust the execution manager, <code>russian_roulette</code>, such exposure won't matter.
Remind that <code>coroutine_handle&lt;void&gt;</code> follows the semantics of <code>void*</code>.
So if you want to prevent some mistakes for future extenstion, 
you had better define or <code>delete</code> copy/move functions and its destructor.</p>
<h3 id="conclusion">Conclusion<a class="headerlink" href="#conclusion" title="Permanent link">&para;</a></h3>
<p><a href="https://godbolt.org/z/rlKE7f">You can run the all-in-one code with the Compiler Explorer.</a></p>
<p>Like https://github.com/Naios/continuable, C++ Coroutines can be used like a sugar for the <code>future&lt;T&gt;</code>. 
But that's the not only usage.</p>
<p>Since the coroutine frame contains an index to distinguish its suspension points, 
we can't tell it is totaly different from the state pattern.
We need to define awaitable type and the return types for our logic, 
but by doing so the point of suspension and continuation can be written more naturally.</p>
<p>For my perspective this gives more resilience to the code.</p>
                
                  
                
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../combining-coroutines-and-pthread_create/" title="Combining C++ coroutines and `pthread_create`" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Combining C++ coroutines and `pthread_create`
              </span>
            </div>
          </a>
        
        
          <a href="../../modules/" title="Groups" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Groups
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            CC-BY-4.0 https://creativecommons.org/licenses/by/4.0/deed
          </div>
        
        powered by
        <a href="https://www.mkdocs.org" target="_blank" rel="noopener">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs</a>
      </div>
      
  <div class="md-footer-social">
    <link rel="stylesheet" href="../../assets/fonts/font-awesome.css">
    
      <a href="https://github.com/luncliff" target="_blank" rel="noopener" title="github" class="md-footer-social__link fa fa-github"></a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/application.c33a9706.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:"../.."}})</script>
      
    
  </body>
</html>